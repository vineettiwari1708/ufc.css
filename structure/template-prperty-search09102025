<?php
/**
 * Template Name: Property Search Page
 */
get_header();
?>

<section class="search-banner-wrapper">
  <div class="header-spacer"></div>

  <video class="bg-video" autoplay loop muted playsinline>
    <source src="http://localhost/urbanfeatconstruction/wp-content/uploads/2025/10/160033-820167238_tiny.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <div class="container h-100 d-flex flex-column justify-content-center align-items-center text-center position-relative ">
    <div class="glass-blur container-fluid">
      <h1 class="mb-4 text-white">Find Your Dream Property</h1>

      <div class="form-wrapper">
        <form method="get" class="row g-3 align-self">
          <div class="col-md-5">
            <select name="location" class="form-select" required>
              <option value="">Select Location</option>
              <option value="delhi" <?php selected($_GET['location'] ?? '', 'delhi'); ?>>Delhi</option>
              <option value="mumbai" <?php selected($_GET['location'] ?? '', 'mumbai'); ?>>Mumbai</option>
              <option value="lucknow" <?php selected($_GET['location'] ?? '', 'lucknow'); ?>>Lucknow</option>
            </select>
          </div>
          <div class="col-md-5">
            <input
              type="text"
              name="keywords"
              class="form-control"
              placeholder="Enter keywords (e.g., villa, 3BHK)"
              value="<?php echo esc_attr($_GET['keywords'] ?? ''); ?>"
            />
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary cus-btn">Search</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<section class="py-5">
  <div class="container position-relative carousel-wrapper">
    <button class="carousel-btn carousel-prev" id="prevBtn">&lt;</button>
    <div class="carousel-container" id="carouselContainer">
      <?php
      $location = sanitize_text_field($_GET['location'] ?? '');
      $keywords = sanitize_text_field($_GET['keywords'] ?? '');

      $args = [
        'post_type'      => 'property',
        'posts_per_page' => 20,
        's'              => $keywords,
        'meta_query'     => [],
      ];
      if ($location) {
        $args['meta_query'][] = [
          'key'     => 'location',
          'value'   => $location,
          'compare' => '=',
        ];
      }

      $property_query = new WP_Query($args);
      if ($property_query->have_posts()) :
        while ($property_query->have_posts()) : $property_query->the_post();
          $property_location = get_post_meta(get_the_ID(), 'location', true);
          $property_price = get_post_meta(get_the_ID(), 'price', true);
          $property_amenities = get_field('property_amenities'); // returns an array

      ?>
        <div class="card property-card shadow-sm">
  <?php if (has_post_thumbnail()) :
    the_post_thumbnail('small', ['class' => 'card-img-top', 'alt' => get_the_title()]);
  endif; ?>

  <div class="card-body">
    <h5 class="card-title"><?php the_title(); ?></h5>
    <p class="card-text text-muted">Location: <?php echo esc_html($property_location); ?></p>
    <p class="card-text">Price: â‚¹<?php echo esc_html($property_price); ?></p>

    <!-- Amenities as badges -->
    <?php if (!empty($property_amenities) && is_array($property_amenities)) : ?>
      <div class="mb-2 d-flex flex-wrap gap-2">
        <?php foreach ($property_amenities as $amenity) : ?>
          <span class="badge bg-info text-dark"><?php echo esc_html($amenity); ?></span>
        <?php endforeach; ?>
      </div>
    <?php else : ?>
      <p class="text-muted">No amenities listed.</p>
    <?php endif; ?>

    <!-- Buttons -->
    <a href="<?php the_permalink(); ?>" class="btn btn-success btn-sm mt-2">View Details</a>
    <a href="<?php the_permalink(); ?>" class="btn btn-danger btn-sm mt-2">Contact</a>
  </div>
</div>

      <?php endwhile;
      else : ?>
        <p>No properties found.</p>
      <?php endif;
      wp_reset_postdata(); ?>
    </div>
    <button class="carousel-btn carousel-next" id="nextBtn">&gt;</button>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const container = document.getElementById('carouselContainer');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if (!container || !prevBtn || !nextBtn) {
    console.warn('Carousel elements missing');
    return;
  }

  function getScrollAmount() {
    const card = container.querySelector('.card');
    if (!card) return 0;
    const style = window.getComputedStyle(card);
    const gap = parseInt(style.marginRight) || 0;
    return card.offsetWidth + gap;
  }

  function updateButtons() {
    prevBtn.disabled = container.scrollLeft <= 0;
    nextBtn.disabled = container.scrollLeft + container.clientWidth >= container.scrollWidth - 1;
  }

  prevBtn.addEventListener('click', function() {
    const amt = getScrollAmount();
    container.scrollBy({ left: -amt, behavior: 'smooth' });
  });
  nextBtn.addEventListener('click', function() {
    const amt = getScrollAmount();
    container.scrollBy({ left: amt, behavior: 'smooth' });
  });

  container.addEventListener('scroll', updateButtons);
  window.addEventListener('resize', updateButtons);
  updateButtons();
});
</script>

<style>
  .header-spacer { height: 0px; }

  .search-banner-wrapper {
    position: relative;
    height: 500px;
    overflow: hidden;
    padding-top: 150px;
  }
  .bg-video {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
  }
  .search-banner-wrapper > .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
  }
  .search-banner-wrapper h1 {
    color: white;
    font-weight: 700;
    text-shadow: 0 2px 6px rgba(0,0,0,0.7);
  }
  .glass-blur {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.5rem 2rem;
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 0 30px rgba(0,0,0,0.3);
  }
  .cus-btn {
    padding: 9px 24px;
  }
  .glass-blur .form-select,
  .glass-blur .form-control {
    height: 45px;
    font-size: 1rem;
    background-color: rgba(255,255,255,0.8);
    color: #000;
  }
  .property-card img {
    height: 180px;
    object-fit: cover;
  }
  .carousel-wrapper {
    position: relative;
    overflow: hidden;
  }
  .carousel-container {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  .carousel-container::-webkit-scrollbar {
    display: none;
  }
  .carousel-container > .card {
    flex: 0 0 30%;
    scroll-snap-align: start;
  }
  .carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    background-color: rgba(0,0,0,0.5);
    border: none;
    color: white;
    width: 40px; height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s;
  }
  .carousel-btn:hover {
    background-color: rgba(0,0,0,0.8);
  }
  .carousel-btn:disabled {
    background-color: rgba(0,0,0,0.2);
    cursor: not-allowed;
  }
  .carousel-prev {
    left: 0;
    margin-left: 10px;
  }
  .carousel-next {
    right: 0;
    margin-right: 10px;
  }
  @media (max-width: 767px) {
    .search-banner-wrapper {
      height: 600px;
      padding-top: 150px;
    }
    .glass-blur .row > div {
      flex: 1 1 100% !important;
    }
    .carousel-container > .card {
      flex: 0 0 80%;
    }
  }
</style>

<?php get_footer(); ?>
